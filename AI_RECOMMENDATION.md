# AI 辅助推荐与 RAG 系统说明 🤖







本文档聚焦于「WHU 课程评价查询系统」中的 AI 辅助推荐模块，详细描述 RAG（Retrieval-Augmented Generation）工作流、数据来源、限流策略以及未来扩展方向，帮助开发者、运营同学或部署人员更好地理解系统运作机制。







---





## 1. 模块概述







AI 辅助推荐模块旨在结合课程评价库与大语言模型，为用户提供个性化课程推荐。其目标包括：







- 根据用户需求描述给出匹配课程，并提供可信的推荐理由；

- 帮助对课程不熟悉的新生快速定位适合自己的选课方案；

- 为课程推广模块提供智能排序依据；

- 通过 RAG 技术保证回答可解释、可追踪，避免“空口”胡诌。







---



## 2. RAG 工作流程







RAG 由「检索层」和「生成层」组成，整体运行顺序如下：







1. **用户输入**  

   - 课程类别（体育课/公选课/公共课/专业课/导引或不限制）；  

   - 需求描述（0-50 字，鼓励用户写出关键诉求，如“给分好”“不用点名”）。







2. **检索阶段**  

   - 系统向课程评价数据库发起检索（可结合向量检索与关键词倒排索引）；  

   - 过滤出符合课程类别的候选评价集合；  

   - 按相似度排序，并截取若干条（通常 3-5 条）作为 RAG context。







3. **生成阶段**  

   - 将候选评价与用户描述拼接为 prompt；  

   - 调用 LLM（后端配置）生成推荐列表，要求输出 Markdown 结构化段落；  

   - LLM 需标注推荐理由中引用的课程信息，确保可追溯。







4. **响应处理**  

   - 后端返回 `recommendations`、`llm_output` 和原始 `rag_results`；  

   - 前端在 `AIRAG.vue` 中渲染卡片，展示课程名称、核心卖点、推荐理由；  

   - 若 `llm_response_text` 为 Markdown，则通过 `markdown-it` 渲染美观文本。







5. **行为记录**  

   - 记录用户设备指纹、使用时间与参数，用于限流与运营统计；  

   - 异常情况（超时、内容空、模型失效）写入监控日志。







---



## 3. 数据来源与知识库构建



### 3.1 数据来源



- **课程评价数据库**：来自学生在 AddCourse 中提交的结构化评价；  

- **课程推广内容**：由教师提交的 CoursePromotion 数据，可作为补充描述；  

- **新生问卷反馈**：FreshmenZone 的调查结果可用于分析用户偏好，间接优化推荐策略。



### 3.2 数据清洗流程



1. 对提交的评价进行敏感词过滤、标点整理、统一字段命名；  

2. 针对课程名称、属性、授课教师等字段进行规范化（例如统一大小写、去除空格）；  

3. 若存在重复评价或冲突信息，通过规则或人工审核进行合并；  

4. 将最终数据导入向量库与搜索索引，以便高效检索。



### 3.3 向量化策略



- 采用开源中文向量模型或自定义嵌入模型，将每条评价生成向量；  

- 统一字段拼接格式，如 “课程名称 + 教师 + 亮点 + 评价摘要”；  

- 存储于向量数据库（如 Faiss、Milvus、ElasticSearch vector）或后端自建结构中；  

- 生成阶段按余弦相似度选取最相关的文档片段。



---



## 4. API 接口参数说明



- **接口地址**：`POST /rag`  

- **请求头**：需附带 `X-Device-Fingerprint`，用于限流  

- **请求体字段**：



| 字段         | 类型   | 必填 | 说明                                              |

|--------------|--------|------|---------------------------------------------------|

| `userQuestion` | string | 是   | 用户的需求描述，0-50 字                           |

| `catagory`     | number | 否   | 课程类别，0-任意、1-体育课、2-公选课、3-公共课、4-专业课、5-导引 |



- **响应字段**：



| 字段                   | 说明                                           |

|------------------------|------------------------------------------------|

| `recommendations`      | 结构化推荐列表，包含课程名与推荐理由           |

| `llm_output`           | LLM 原始输出（便于调试）                       |

| `llm_response_text`    | 格式化后的 Markdown 文本                       |

| `rag_results`          | 检索阶段命中的原始数据集                      |



- **超时**：前端调用设置 120 秒超时，上层可根据业务环境调整。



---



## 5. 限流与安全策略



### 5.1 设备指纹



- 使用 FingerprintJS 在前端生成唯一 ID，存储于 `localStorage`；  

- 每次调用 `/rag` 接口必须带上 `X-Device-Fingerprint`；  

- 后端根据指纹 + Cookie 判断是否超限，减少刷接口的风险。



### 5.2 权限验证



- 仅对已提交课程评价或完成新生问卷的用户开放 AI 推荐；  

- 若用户 Cookie 被清除，需要重新贡献内容才能解锁；  

- `App.vue` 在 `created` 钩子中负责同步这些状态。



### 5.3 使用次数限制



- 通过 Cookie `ai_uses_left` 或服务器端计数记录剩余次数；  

- 每周（默认周四）自动重置，用于保障模型资源；  

- 超限时后端返回特定错误码（如 429），前端展示友好提示。



### 5.4 内容安全



- 后端对用户描述与模型输出进行内容审核（敏感词、政策限制等）；  

- 对 LLM 返回的 Markdown 进行转义处理，防止 XSS；  

- 重要日志包含请求参数匿名化后的摘要，便于问题追踪。



---



## 6. 前端交互与 UI 实现



- `AIRAG.vue` 使用 Element Plus 表单收集用户描述和课程类型，然后调用 `handleAiRecommend` 方法；  

- 采用 `markdown-it` 渲染 `llm_response_text`，可支持表格、列表等格式；  

- 请求状态通过 Element Plus 的加载动画反馈（按钮 loading / 全局 `v-loading`）；  

- 结果卡片展示课程名称、推荐亮点、原始评价片段，可在 `SearchResults` 组件中复用部分 UI 样式；  

- 若接口返回 `rag_results`，可提供「查看引用」按钮，增强透明度。



---



## 7. 错误处理策略



| 场景                     | 前端表现                                 | 处理方式                                    |

|--------------------------|------------------------------------------|---------------------------------------------|

| 请求超时 or 网络断开     | 通知用户网络异常                         | 显示 `ElMessage` 提示，鼓励稍后重试         |

| 权限未满足               | 提示先提交评价或问卷                     | 跳转/提示用户前往 AddCourse / FreshmenZone  |

| AI 使用次数耗尽          | 显示剩余次数为 0                         | 告知周四刷新，或引导课程推广模块            |

| LLM 返回空结果           | 显示“暂未找到匹配课程”                   | 可提供标准课程搜索作为降级方案              |

| 服务器错误 / 429         | 返回错误消息                              | 统一在 `catch` 中解析 error.response        |



---



## 8. 监控与日志



- 前端：统计 `handleAiRecommend` 成功/失败次数，记录 `responseTime`；  

- 后端：记录请求基数、限流触发次数、模型调用耗时、异常日志；  

- 建议集成 Sentry 或 Prometheus/Grafana，用于监测模型可用性与延迟；  

- 定期导出用户需求描述（匿名化）供产品分析，优化推荐逻辑。



---



## 9. 调参与扩展建议



1. **课程类别扩展**  

   - 可引入更多标签（实践课、实验课、艺术类等），并与课程推广模块打通；



2. **多轮对话能力**  

   - 在前端添加会话上下文，允许 AI 逐步细化推荐；



3. **向量库更新策略**  

   - 定期同步新评价；对热门课程配置高优先级，缩短检索延迟；



4. **模型多样化**  

   - 支持切换不同的 LLM，或在响应中注明当前模型版本，以便 A/B 测试；



5. **反作弊机制**  

   - 结合 IP 限制、行为评分（例如提交评价后立即大量调用 AI）等策略，进一步抑制恶意请求；



6. **可视化反馈**  

   - 在推荐卡片中添加「引用来源」链接，指向对应的 SearchResults 详情，提升可信度；



7. **运营数据面板**  

   - 汇总用户需求、推荐点击率、课程覆盖度，帮助运营优化课程供给。



---



## 10. 与项目其它模块的关系



- **AddCourse / SearchForm**：AI 推荐依赖学生评价库，鼓励用户贡献内容；  

- **FreshmenZone**：对新生提供问卷解锁 AI，增强体验的同时获取偏好数据；  

+- **CoursePromotion**：可将推广课程作为 AI 推荐候选，提升曝光度；  

- **Cookies / FingerprintJS**：共同构成权限验证与限流的基础设施；  

- **Statistics**：AI 模块的调用次数可计入统计，丰富首页指标。



---





## 11. 常见问题（FAQ）



**Q1：AI 推荐结果是否完全可靠？**  

A：推荐依据真实评价，但评价本身可能存在主观性，用户仍需结合实际需求判断。



**Q2：为什么每周四重置使用次数？**  

A：周四是教务系统常规维护日，便于统一刷新资源，也能控制成本。



**Q3：能否在移动端使用？**  

A：可以，AIRAG 组件已做响应式适配，但建议在稳定网络环境下操作。



**Q4：接口超时怎么办？**  

A：通常是模型响应较慢或网络不稳定，可稍后重试或使用普通搜索作为备选方案。



---



**适用范围**: WHU 课程评价查询系统内的 AI 辅助推荐模块  



如需反馈或扩展，请通过项目 Issue 或直接联系维护者。

